---
import Layout from '../layouts/Layout.astro';
---

<Layout title="Mi Perfil">
    <div id="order-modal" class="fixed inset-0 bg-black/50 hidden z-50 flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white w-full max-w-2xl rounded-2xl shadow-2xl overflow-hidden animate-in fade-in zoom-in duration-200">
            <div class="p-6 border-b flex justify-between items-center bg-gray-50">
                <div>
                    <h2 class="text-xl font-black uppercase" id="modal-order-id">Detalle de Orden</h2>
                    <p class="text-[10px] text-gray-400 font-bold uppercase" id="modal-order-date"></p>
                </div>
                <button onclick="closeModal()" class="text-gray-400 hover:text-red-500 text-2xl font-bold">&times;</button>
            </div>
            <div id="modal-content" class="p-6 max-height-[70vh] overflow-y-auto space-y-4">
                </div>
            <div class="p-6 border-t bg-gray-50 flex justify-between items-center">
                <span class="font-bold text-gray-500 uppercase text-xs">Total Pagado:</span>
                <span class="text-2xl font-black text-blue-600" id="modal-total"></span>
            </div>
        </div>
    </div>

    <div class="max-w-4xl mx-auto space-y-8 mt-10 px-4 pb-20">
        <header class="bg-white p-8 rounded-2xl shadow-sm border border-gray-100 flex justify-between items-center">
            <div>
                <h1 class="text-3xl font-black uppercase tracking-tighter text-gray-800">Panel de Usuario</h1>
                <p class="text-gray-400 text-sm font-medium">Historial de transacciones y pedidos.</p>
            </div>
            <button onclick="logout()" class="text-[10px] font-bold bg-red-50 text-red-500 px-4 py-2 rounded-full hover:bg-red-500 hover:text-white transition-all uppercase tracking-widest">
                Cerrar Sesi√≥n
            </button>
        </header>

        <section>
            <h2 class="text-xs font-black text-gray-400 uppercase tracking-widest mb-4">Mis Pedidos Recientes</h2>
            <div id="orders-container" class="space-y-4">
                <p class="text-gray-500 italic">Consultando servidor...</p>
            </div>
        </section>
    </div>

    <script is:inline>
        // üõ°Ô∏è PROTECCI√ìN DE RUTA
        if (!localStorage.getItem('token')) {
            window.location.href = '/login';
        }

        let ordersData = []; // Guardaremos las √≥rdenes aqu√≠ para acceder r√°pido al detalle

        async function loadOrders() {
            const API_URL = import.meta.env.PUBLIC_API_URL;
            const ordersContainer = document.getElementById('orders-container');
            const token = localStorage.getItem('token');

            try {
                const res = await fetch(`${API_URL}/orders`, { 
                    headers: { 'Authorization': `Bearer ${token}`, 'Accept': 'application/json' }
                });

                const result = await res.json();

                if (res.ok && result.status === "success") {
                    ordersData = result.data.orders || [];
                    
                    if (ordersData.length === 0) {
                        ordersContainer.innerHTML = `<div class="bg-white p-10 rounded-xl border border-dashed text-center"><p class="text-gray-400 uppercase font-bold text-xs">No hay compras registradas</p></div>`;
                        return;
                    }

                    ordersContainer.innerHTML = ordersData.map((order) => `
                        <div class="bg-white p-6 rounded-xl border border-gray-100 flex justify-between items-center hover:shadow-md transition-all group">
                            <div class="space-y-2">
                                <div class="flex items-center gap-3">
                                    <span class="text-[10px] font-black bg-blue-600 text-white px-2 py-0.5 rounded italic">#ORD-${order.id}</span>
                                    <span class="text-xs font-bold text-gray-400 uppercase">${new Date(order.createdAt).toLocaleDateString()}</span>
                                </div>
                                <p class="font-black text-gray-900 text-xl tracking-tight">$${order.totalAmount.toFixed(2)}</p>
                                <p class="text-[10px] font-bold text-gray-500 uppercase tracking-widest">${order.items.length} Productos adquiridos</p>
                            </div>
                            <div class="flex flex-col items-end gap-3">
                                <span class="px-3 py-1 rounded-full text-[9px] font-black uppercase tracking-tighter ${order.status === 'COMPLETED' ? 'bg-green-100 text-green-600' : 'bg-yellow-100 text-yellow-600'}">
                                    ${order.status}
                                </span>
                                <button onclick="showDetail(${order.id})" class="text-[10px] font-black text-blue-600 border-b-2 border-transparent hover:border-blue-600 uppercase tracking-widest transition-all">
                                    Ver Detalle ‚Üí
                                </button>
                            </div>
                        </div>
                    `).join('');
                } else {
                    ordersContainer.innerHTML = '<p class="text-red-500">Error al cargar datos.</p>';
                }
            } catch (err) {
                ordersContainer.innerHTML = '<p class="text-red-500">Error de conexi√≥n.</p>';
            }
        }

        // L√ìGICA DEL MODAL (VER M√ÅS)
        window.showDetail = (orderId) => {
            const order = ordersData.find(o => o.id === orderId);
            if (!order) return;

            document.getElementById('modal-order-id').innerText = `ORDEN #ORD-${order.id}`;
            document.getElementById('modal-order-date').innerText = `Fecha: ${new Date(order.createdAt).toLocaleString()}`;
            document.getElementById('modal-total').innerText = `$${order.totalAmount.toFixed(2)}`;

            const content = order.items.map(item => `
                <div class="flex gap-4 items-center bg-gray-50 p-4 rounded-xl border border-gray-100">
                    <div class="w-12 h-12 bg-blue-600 rounded flex items-center justify-center text-white font-black text-xs">LIB</div>
                    <div class="flex-1">
                        <h4 class="text-sm font-black text-gray-800 uppercase leading-none mb-1">${item.product.name}</h4>
                        <p class="text-[10px] text-gray-500 font-bold uppercase tracking-tight italic">Autor: ${item.product.author}</p>
                    </div>
                    <div class="text-right">
                        <p class="text-xs font-black text-gray-900">${item.quantity} x $${item.unitPrice}</p>
                        <p class="text-[10px] font-bold text-blue-600">Sub: $${(item.quantity * item.unitPrice).toFixed(2)}</p>
                    </div>
                </div>
            `).join('');

            document.getElementById('modal-content').innerHTML = content;
            document.getElementById('order-modal').classList.remove('hidden');
            document.body.style.overflow = 'hidden'; // Evita scroll atr√°s
        };

        window.closeModal = () => {
            document.getElementById('order-modal').classList.add('hidden');
            document.body.style.overflow = 'auto';
        };

        window.logout = () => {
            localStorage.clear();
            window.location.href = '/login';
        };

        loadOrders();
    </script>
</Layout>