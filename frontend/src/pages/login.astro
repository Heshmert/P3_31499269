---
import Layout from '../layouts/Layout.astro';
---

<Layout title="Iniciar Sesión">
	<div class="max-w-md mx-auto bg-white p-8 border border-gray-200 rounded-lg shadow-sm">
		<h1 class="text-2xl font-bold mb-6 text-center">Bienvenido de nuevo</h1>
		
		<form id="login-form" class="space-y-4">
			<div>
				<label class="block text-sm font-medium">Email</label>
				<input type="email" id="email" required class="w-full p-2 border rounded mt-1" placeholder="tu@email.com" />
			</div>
			<div>
				<label class="block text-sm font-medium">Contraseña</label>
				<input type="password" id="password" required class="w-full p-2 border rounded mt-1" />
			</div>
			<button type="submit" class="w-full bg-blue-600 text-white py-2 rounded font-semibold hover:bg-blue-700 transition-colors">
				Entrar
			</button>
			<p id="error-msg" class="text-red-500 text-sm hidden text-center"></p>
		</form>
	</div>

	<script>
		const loginForm = document.getElementById('login-form') as HTMLFormElement;
		const errorMsg = document.getElementById('error-msg');
		const API_URL = import.meta.env.PUBLIC_API_URL;

		loginForm?.addEventListener('submit', async (e) => {
			e.preventDefault();
			const email = (document.getElementById('email') as HTMLInputElement).value;
			const password = (document.getElementById('password') as HTMLInputElement).value;

			try {
				const res = await fetch(`${API_URL}/auth/login`, {
					method: 'POST',
					headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify({ email, password })
				});

				const data = await res.json();

				if (res.ok) {
    // IMPORTANTE: Según tu API, el token suele estar en data.data.token 
    // o simplemente data.token si la respuesta es directa.
    // Vamos a asegurar capturarlo bien:
    const token = data.data?.token || data.token || (typeof data === 'string' ? data : null);
    
				if (token) {
					localStorage.setItem('token', token);
					console.log("✅ Token guardado correctamente");
					window.location.href = '/';
				} else {
					console.error("❌ No se encontró token en la respuesta", data);
				}
			}	
			} catch (err) {
				console.error(err);
			}
		});
	</script>
</Layout>